CREATE PROCEDURE [dbo].[PS_PAYS]

	@FLAGIN INT,
	@CHAMPCTRL VARCHAR(80),

	@LIBELLE VARCHAR(35),
	@LIBELLEGR VARCHAR(50),

	@LIBELLEUS VARCHAR(35),
	@NATIONALITE VARCHAR(50),
	@CODEISO1 VARCHAR(2),
	@CODEISO2 VARCHAR(3),
	@CODEISO3 VARCHAR(3),
	@INDICATIF VARCHAR(5),
	@SHORTLIB VARCHAR(3),
	@DEVISE VARCHAR(3),
	@DEVISELIBELLE VARCHAR(35),
	@INTERDIT VARCHAR(1),
	@DEBUTINTERDIT DATETIME,
	@FININTERDIT DATETIME,

	@ENQUETE1 VARCHAR(10),
	@STATUT1 VARCHAR(10),
	@ENQUETE2 VARCHAR(10),
	@STATUT2 VARCHAR(10),
	@ENQUETE3 VARCHAR(10),
	@STATUT3 VARCHAR(10),
	@ID VARCHAR(18) OUTPUT
AS
	DECLARE @FLAG VARCHAR(14)
	DECLARE @IDENTITY VARCHAR(14)
BEGIN
	IF EXISTS (SELECT * FROM PAYS WHERE PAYSID =
				CASE
					WHEN @CHAMPCTRL = 'LIBELLE' THEN @LIBELLE
					WHEN @CHAMPCTRL = 'LIBELLEGR' THEN @LIBELLEGR
					ELSE @LIBELLE
				END
	) BEGIN
		SET @ID = CASE
					WHEN @CHAMPCTRL = 'LIBELLE' THEN @LIBELLE
					WHEN @CHAMPCTRL = 'LIBELLEGR' THEN @LIBELLEGR
					ELSE @LIBELLE
				END
		SET @ID = @ID + ',0,0'
	END
	ELSE BEGIN
		IF (@LIBELLE IS NULL) OR LTRIM(@LIBELLE) = '' BEGIN
			SET @ID = 'VPARDEFAUT,0,0'
		END
		ELSE BEGIN
			SET @LIBELLE = UPPER(@LIBELLE)
			IF EXISTS (SELECT * FROM PAYS WHERE UPPER(LIBELLE) = UPPER(@LIBELLE)) BEGIN
				SET @ID = (SELECT TOP 1 PAYSID FROM PAYS WHERE UPPER(LIBELLE) = UPPER(@LIBELLE))
				UPDATE PAYS SET LIBELLE = @LIBELLE, LIBELLEGR = @LIBELLEGR, LIBELLEUS = @LIBELLEUS, NATIONALITE = @NATIONALITE, CODEISO2 = @CODEISO2, CODEISO3 = @CODEISO3, INDICATIF = @INDICATIF, DEVISELIBELLE = @DEVISELIBELLE, DATEMAJ = CURRENT_TIMESTAMP WHERE PAYSID = @ID
				SET @ID = @ID + ',0,1'
			END
			ELSE BEGIN
				IF EXISTS (SELECT * FROM PAYS WHERE UPPER(NATIONALITE) = UPPER(@NATIONALITE)) BEGIN
					SET @ID = (SELECT TOP 1 PAYSID FROM PAYS WHERE UPPER(NATIONALITE) = UPPER(@NATIONALITE))
					SET @ID = @ID + ',0,0'
				END
				ELSE BEGIN
					IF EXISTS (SELECT TOP 1 PAYSID FROM PAYS WHERE UPPER(LIBELLE) ='INCONNU') BEGIN
						SET @ID = (SELECT TOP 1 PAYSID FROM PAYS WHERE UPPER(LIBELLE) ='INCONNU')
						SET @ID = @ID + ',0,0'
					END
					ELSE BEGIN
						IF @FLAGIN=1 BEGIN
							INSERT INTO SEQ_IDENTITY(LIBELLE) VALUES ('OK')
							SET @IDENTITY = (SELECT @@IDENTITY AS ID)
							SET @FLAG = (SELECT SUBSTRING(VERSION, 1, 3) FROM VERSION_SFW)
							SET @ID = @FLAG + @IDENTITY
							INSERT INTO PAYS (PAYSID, LIBELLE, LIBELLEGR, LIBELLEUS, NATIONALITE, CODEISO1,CODEISO2, CODEISO3, INDICATIF, SHORTLIB,DEVISE,DEVISELIBELLE,INTERDIT, DEBUTINTERDIT, FININTERDIT, ENQUETE1,STATUT1,ENQUETE2,STATUT2,ENQUETE3,STATUT3,DATECREATION, DATEMAJ)
							VALUES(@ID, @LIBELLE, @LIBELLEGR,@LIBELLEUS, @NATIONALITE, @CODEISO1,@CODEISO2, @CODEISO3,@INDICATIF,@SHORTLIB,@DEVISE,@DEVISELIBELLE,0, CONVERT(DATETIME,CONVERT(VARCHAR,CURRENT_TIMESTAMP,103),103) , CURRENT_TIMESTAMP + 36525, @ENQUETE1,@STATUT1,@ENQUETE2,@STATUT2,@ENQUETE3,@STATUT3,CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
							SET @ID = @ID + ',1,0'
						END
						ELSE
						SET @ID='VPARDEFAUT,0,0'
					END
				END
			END
		END
	END
END